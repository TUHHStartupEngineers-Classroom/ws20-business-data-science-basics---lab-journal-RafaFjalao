---
title: "Journal (reproducible report)"
author: "Rafael Fernandez Jalao"
date: "2020-11-05"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

**IMPORTANT:** You can delete everything in here and start fresh. You might want to start by not deleting anything above this line until you know what that stuff is doing.

Last compiled: `r Sys.Date()`

# FIRST ASSIGNMENT

In this first assignment we had to analyze the sales of bikes in the different states of Germany. There are two challenges: analyze the sales by location (state) with a bar plot and the sales by location and year.

## Data manipulation and cleaning
This part is common for both challenges
```{r}
library(tidyverse)
library(readr)
library(lubridate)

bikes_tbl <- read_excel(path='00_data/01_bike_sales/01_raw_data/bikes.xlsx')
orderlines_tbl <- read_excel(path='00_data/01_bike_sales/01_raw_data/orderlines.xlsx')
bikeshops_tbl <-read_excel(path='00_data/01_bike_sales/01_raw_data/bikeshops.xlsx')


bike_orderlines_joined_tbl <- orderlines_tbl %>%
  left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>%
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))

bike_orderlines_wrangled_tbl<- bike_orderlines_joined_tbl %>%
  #Separate State and city
  separate(col= location, into=c ("city", "state"), sep = ',') %>%
  # Selection of necessary data
  select (...1, order.id, order.date, quantity, price, state)%>%
  #Total price
  mutate (total_price = price*quantity)%>%
  #Correcting the point
  set_names(names(.) %>% str_replace_all("\\.", "_"))
```

## first challenge: Sales by states 
```{r}
#Step 1: Preparing the represented dat<
sales_by_state<- bike_orderlines_wrangled_tbl %>%
  #Selecting the necessary data
  select (state, total_price)%>%
  group_by(state)%>%
  summarize(sales= sum(total_price))%>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))
```
```{r plot1, fig.width=12, fig.height=6}
sales_by_state%>%
  ggplot(aes(x=state, y=sales ))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  # Geometries
  geom_col(fill = "#2DC6D6") + # Use geom_col for a bar plot
  geom_label(aes(label = sales_text)) +
  # Adding labels to the bars

  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +

  labs(
    title    = "SALES BY STATE",
    subtitle = "",
    x = "", # Override defaults for x and y
    y = "Revenue"
  )
```

## Second challenge: Sales by State and Year 
```{r}
sales_state_year <- bike_orderlines_wrangled_tbl %>%
  
  select(order_date, total_price, state) %>%
  mutate (year = year(order_date))%>%
  group_by(year, state)%>%
  summarise(sales=sum(total_price))%>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))


```
```{r plot2, fig.width=10, fig.height=10}
sales_state_year%>%
  
  # Set up x, y, fill
  ggplot(aes(x = year, y = sales, fill = state)) +
  
  # Geometries
  geom_col() + # Run up to here to get a stacked bar plot
  
  # Facet
  facet_wrap(~state) +
  
  # Formatting
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title = "REVENUE BY YEAR AND STATE",
    subtitle = "",
    fill = "States" )# Changes the legend name

```
# SECOND ASSIGMMENT

This assignment are related with the Data Acquisition. In this assignment there are two challenges: Get some data via an API and scrape one of the competitor websites of canyon and create a data base which contain the model names and prices for at least one category

## First Challenge:APIs 
 
 (...)
 
## Second Challenge: SCRAPE A WEBPAGE

In this second challenge we had to  crape one of the competitor websites of canyon and create a data base which contain the model names and prices for at least one category. I have chosen the competitor Rose Bikes. 
I have decided to do it to all categories. 
For each category, I will  get the price for a model(represented in the web-page with from €...). The process could go a little bit deeper and get the price for every variation of the model. However, due to the limitation of time, I will just take the base price for each model. I named every category as family.

```{r}
library(tidyverse) # Main Package - Loads dplyr, purrr, etc.
library(rvest)     # HTML Hacking & Web Scraping
library(xopen)     # Quickly opening URLs
library(jsonlite)  # converts JSON files to R objects
library(glue)      # concatenate strings
library(stringi) 
library(dplyr)


# Second Challenge

url_home <- "https://www.rosebikes.com/bikes" # get the URL

html_home <- url_home %>%
  read_html()                         # get the HTML        

# Here we will get the different families 
family_tbl <- html_home%>%
  html_nodes(css=".main-navigation-category-with-tiles__title") %>%
  html_text()%>%
  discard(.p = ~stringr::str_detect(.x,"Urban|Sale|Kids|Bikes"))%>% #deleting
  as_tibble()

# Creating a vector for interaction

ivector <- as_vector(1:nrow(family_tbl)) 

family_name_tbl <- as_tibble()

family_name_price_tbl<- as_tibble()
bikes_data_tbl <- as_tibble()
# In this iteration we will get the model name and the price of everyone
for (i in ivector){
family_name_tbl<- as_tibble() 
name <- family_tbl[i,1]%>%
  str_replace_all("\n", "")
  
# Goes to the page of the family
url_home <- glue("https://www.rosebikes.com/bikes/{name}")


html<- url_home %>%
  read_html
# Get the model names
model_name_tbl<- html%>%
  html_nodes(css=".catalog-category-bikes__title-text") %>%
  html_text()%>%
  str_replace_all(pattern="\n",replacement = "")%>%
  as_tibble()%>%
  rename(model_name=value)
# get the prices
price_tbl <- html%>%
  html_nodes(css=".catalog-category-bikes__price-title") %>%
  html_text()%>%
  str_replace_all(pattern=",",replacement = "")%>%  # Delete the comma
  str_replace_all(pattern="\n",replacement = "")%>% # delete the \n
  as_tibble()%>%
  separate(col=value, into =c("from","price"), sep= "€")%>% #eliminating from
  select("price")
  


ivector_family<- as_vector(1:nrow(price_tbl))
# Creates a tibble with the family name to add it to every model
for (i in ivector_family){
  
  family_name_tbl[i,1]<-name
}

family_name_tbl <-family_name_tbl%>%
  rename (family_name=...1)

# Put all the  previous calculation together
family_name_price_tbl<- bind_cols(family_name_tbl, model_name_tbl, price_tbl)

#Collect all the data in a tibble

bikes_data_tbl<- bind_rows(bikes_data_tbl, family_name_price_tbl)


}                                         
#Results
bikes_data_tbl

# The Values with NA are there because they are bikes which are not available at the moment
#Ilustrating a few more data

bikes_data_tbl [23,1]

bikes_data_tbl [23,2]

bikes_data_tbl [23,3]

bikes_data_tbl [30,1]

bikes_data_tbl [30,2]

bikes_data_tbl [30,3]

```










