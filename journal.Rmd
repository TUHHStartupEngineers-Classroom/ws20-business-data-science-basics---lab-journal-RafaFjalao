---
title: "Journal (reproducible report)"
author: "Rafael Fernandez Jalao"
date: "2020-11-05"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

**IMPORTANT:** You can delete everything in here and start fresh. You might want to start by not deleting anything above this line until you know what that stuff is doing.

Last compiled: `r Sys.Date()`

# FIRST ASIGMMENT

In this first challenge we had to analyze the sales of bikes in the different states of Germany:Analyze the sales by location (state) with a bar plot and the sales by location and year

## Data manipulation and cleaning

```{r}
library(tidyverse)
library(readr)
library(lubridate)

bikes_tbl <- read_excel(path='00_data/01_bike_sales/01_raw_data/bikes.xlsx')
orderlines_tbl <- read_excel(path='00_data/01_bike_sales/01_raw_data/orderlines.xlsx')
bikeshops_tbl <-read_excel(path='00_data/01_bike_sales/01_raw_data/bikeshops.xlsx')


bike_orderlines_joined_tbl <- orderlines_tbl %>%
  left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>%
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))

bike_orderlines_wrangled_tbl<- bike_orderlines_joined_tbl %>%
  #Separate State and city
  separate(col= location, into=c ("city", "state"), sep = ',') %>%
  # Selection of necessary data
  select (...1, order.id, order.date, quantity, price, state)%>%
  #Total price
  mutate (total_price = price*quantity)%>%
  #Correcting the point
  set_names(names(.) %>% str_replace_all("\\.", "_"))
```

## Sales by states 
```{r}
#Step 1: Preparing the represented dat<
sales_by_state<- bike_orderlines_wrangled_tbl %>%
  #Selecting the necessary data
  select (state, total_price)%>%
  group_by(state)%>%
  summarize(sales= sum(total_price))%>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))
```
```{r plot1, fig.width=12, fig.height=6}
sales_by_state%>%
  ggplot(aes(x=state, y=sales ))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  # Geometries
  geom_col(fill = "#2DC6D6") + # Use geom_col for a bar plot
  geom_label(aes(label = sales_text)) +
  # Adding labels to the bars

  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +

  labs(
    title    = "SALES BY STATE",
    subtitle = "",
    x = "", # Override defaults for x and y
    y = "Revenue"
  )
```

## Sales by State and Year 
```{r}
sales_state_year <- bike_orderlines_wrangled_tbl %>%
  
  select(order_date, total_price, state) %>%
  mutate (year = year(order_date))%>%
  group_by(year, state)%>%
  summarise(sales=sum(total_price))%>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))


```
```{r plot2, fig.width=10, fig.height=10}
sales_state_year%>%
  
  # Set up x, y, fill
  ggplot(aes(x = year, y = sales, fill = state)) +
  
  # Geometries
  geom_col() + # Run up to here to get a stacked bar plot
  
  # Facet
  facet_wrap(~state) +
  
  # Formatting
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title = "REVENUE BY YEAR AND STATE",
    subtitle = "",
    fill = "States" )# Changes the legend name

```
